<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
    <%@ page import="library.*" %>
    <%@ page import="java.io.*,java.util.*,java.sql.*,javax.servlet.*,java.util.Date,java.util.SimpleDateFormat" %>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Save Rent</title>
</head>
<body>
<%
	try{
		int student_Id=Integer.parseInt(request.getParameter("studentId"));
		int book_Id=Integer.parseInt(request.getParameter("bookId"));
		String returnDateString = request.getParameter("returnDate");
		String rentDateString = request.getParameter("rentDate");
		//SimpleDateFormat sdf = new SimpleDateFormat("dd/MM/yyyy"); 
		//Date returnDate = sdf.parse();
        //Date date = new Date();
       try{
    	   Class.forName("com.mysql.cj.jdbc.Driver");
    		Connection con = DriverManager.getConnection("jdbc:mysql://localhost:3306/StudentManagment","root","minkoko");
    	   
        if(rentDateString != ""){
			String sql = "insert into RentReturn(id,student_Id,book_Id,rent_Date,return_Date,book_Rent,book_Return) values(null,?,?,?,null,?,?)"; 
			PreparedStatement ps = con.prepareStatement(sql);
			ps.setInt(1,student_Id);
			ps.setInt(2,book_Id);
			ps.setString(3, rentDateString);
			ps.setString(4,null);
			ps.setString(5,"1");
			ps.setString(6, "0");
			int status = ps.executeUpdate();
			if(status>0){
				System.out.println("Insert is successful!");
			}
			
			String destination ="RentList.jsp";
			
			RequestDispatcher rd = request.getRequestDispatcher(destination);
			
			Statement stm = con.createStatement();
			
			ResultSet rs = stm.executeQuery("select * from RentReturn");
			
			List<RentReturn> RRList = new ArrayList<RentReturn>();
			
			while(rs.next()){
				RentReturn rr = new RentReturn(rs.getInt("id"),rs.getInt("student_Id"),rs.getInt("book_Id"),rs.getString("rent_Date"),rs.getString("return_Date"),rs.getString("book_Rent"),rs.getString("book_Return"));
				RRList.add(rr);
			}
			con.close();
			request.setAttribute("RentReturnList",RRList);
			rd.forward(request,response);
			
        }else{
        	String sql = "insert into RentReturn(id,student_Id,book_Id,rent_Date,return_Date,book_Rent,book_Return) values(null,?,?,null,?,?,?)"; 
			PreparedStatement ps = con.prepareStatement(sql);
			ps.setInt(1,student_Id);
			ps.setInt(2,book_Id);
			ps.setString(3, null);
			ps.setString(4,returnDateString);
			ps.setString(5,"1");
			ps.setString(6, "0");
			int status = ps.executeUpdate();
			if(status>0){
				System.out.println("Insert is successful!");
			}
			
			String destination ="RentList.jsp";
			
			RequestDispatcher rd = request.getRequestDispatcher(destination);
			
			Statement stm = con.createStatement();
			
			ResultSet rs = stm.executeQuery("select * from RentReturn");
			
			List<RentReturn> RRList = new ArrayList<RentReturn>();
			
			while(rs.next()){
				RentReturn rr = new RentReturn(rs.getInt("id"),rs.getInt("student_Id"),rs.getInt("book_Id"),rs.getString("rent_Date"),rs.getString("return_Date"),rs.getString("book_Rent"),rs.getString("book_Return"));
				RRList.add(rr);
			}
			con.close();
			request.setAttribute("RentReturnList",RRList);
			rd.forward(request,response);
			
        
        }
       // System.out.println(sql);
        
       }catch(SQLException e){
    	   e.printStackTrace();
       }
	}catch(Exception e){
		e.printStackTrace();
	}
%>
</body>
</html>